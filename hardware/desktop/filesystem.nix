# file: hardware/filesystem-laptop.nix
# desc: (mostly) auto generated file for the hardware of my laptop

# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, ... }:

{
  boot = {
    initrd = {
      /*
       * fTPM not working under Linux
       * TEMPORARY SOLUTION (throwing away single drives without thinking should work and I can still use Wake on LAN)
       * find -L /dev/disk -samefile /dev/sdh2
       * dd status=progress bs=2048 if=/etc/nixos/secrets/keys/luks/main of=/dev/sdh2 seek=0
       */
      luks.devices = {
        "main1" = {
          device = "/dev/disk/by-label/main1";
          keyFile = "/dev/disk/by-partuuid/c58965ae-8061-714c-94ef-11c57da14a63";
          keyFileSize = 2048;
        };
        "main2" = {
          device = "/dev/disk/by-label/main2";
          keyFile = "/dev/disk/by-partuuid/c58965ae-8061-714c-94ef-11c57da14a63";
          keyFileSize = 2048;
        };
      };
    };
  };

  # https://www.freedesktop.org/software/systemd/man/latest/crypttab.html
  # nofail -> no Before=cryptsetup.target
  environment.etc."crypttab".text = ''
    array1  /dev/disk/by-label/array1   /dev/disk/by-partuuid/3375b91e-8e21-7e46-ad42-fcdc11b8858a  nofail,keyfile-size=2048
    array3  /dev/disk/by-label/array3   /dev/disk/by-partuuid/3375b91e-8e21-7e46-ad42-fcdc11b8858a  nofail,keyfile-size=2048
    array4  /dev/disk/by-label/array4   /dev/disk/by-partuuid/3375b91e-8e21-7e46-ad42-fcdc11b8858a  nofail,keyfile-size=2048

    ram1    /dev/disk/by-label/ram1     /dev/disk/by-partuuid/7bf59cfb-f4ea-c047-84b0-8b7ac74d76a4  nofail,keyfile-size=2048,discard
    ram3    /dev/disk/by-label/ram3     /dev/disk/by-partuuid/7bf59cfb-f4ea-c047-84b0-8b7ac74d76a4  nofail,keyfile-size=2048,discard
    ram4    /dev/disk/by-label/ram4     /dev/disk/by-partuuid/7bf59cfb-f4ea-c047-84b0-8b7ac74d76a4  nofail,keyfile-size=2048,discard
    ram5    /dev/disk/by-label/ram5     /dev/disk/by-partuuid/7bf59cfb-f4ea-c047-84b0-8b7ac74d76a4  nofail,keyfile-size=2048,discard
  '';

  # https://www.freedesktop.org/software/systemd/man/latest/systemd-fstab-generator.html
  fileSystems =
  let
    bfs-opts = [ "compress=zstd:3" ];
  in
  {
    "/" = {
      device = "tmpfs";
      fsType = "tmpfs";
      options = [
        "size=256M"
        "mode=755"
      ];
    };
    "/boot" = {
      device = "/dev/disk/by-uuid/F6A6-57AC";
      fsType = "vfat";
      options = [
        "umask=0077"
        "shortname=winnt"
      ];
    };
    "/home" = {
      device = "/dev/disk/by-label/main";
      fsType = "btrfs";
      options = bfs-opts ++ [ "subvol=home" ];
      neededForBoot = true;
    };
    "/nix" = {
      device = "/dev/disk/by-label/main";
      fsType = "btrfs";
      options = bfs-opts ++ [ "subvol=nix" ];
      # implicit neededForBoot
    };
    "/var" = {
      device = "/dev/disk/by-label/main";
      fsType = "btrfs";
      options = bfs-opts ++ [ "subvol=var" ];
      # implicit neededForBoot
    };

    "/mnt/main" = {
      device = "/dev/disk/by-label/main";
      fsType = "btrfs";
      options = bfs-opts ++ [ "subvol=/" ];
      neededForBoot = true;
    };
    "/mnt/array" = {
      device = "/dev/disk/by-label/array";
      fsType = "btrfs";
      options = [
        "compress-force=zstd:3"
        "subvol=/"
        "nofail" # no Before=local-fs.target
        "x-systemd.requires=systemd-cryptsetup@array1.service"
        "x-systemd.requires=systemd-cryptsetup@array3.service"
        "x-systemd.requires=systemd-cryptsetup@array4.service"
      ];
    };
    "/mnt/ram" = {
      device = "/dev/disk/by-label/ram";
      fsType = "btrfs";
      options = bfs-opts ++ [
        "subvol=/"
        "nofail" # no Before=local-fs.target
        "x-systemd.requires=systemd-cryptsetup@ram1.service"
        "x-systemd.requires=systemd-cryptsetup@ram3.service"
        "x-systemd.requires=systemd-cryptsetup@ram4.service"
        "x-systemd.requires=systemd-cryptsetup@ram5.service"
      ];
    };

    "/mnt/backup/USB/data" = {
      device = "/dev/mapper/usb-backup";
      fsType = "btrfs";
      options = [ "noauto" ];
    };
  };

  swapDevices = [
    {
      # random encryption will resetup the LUKS header
      # using by-partuuid should not change between system reboots or kernel updates
      device = "/dev/disk/by-partuuid/85439545-b3f4-f742-948f-e3a7190f5fc7";
      randomEncryption.enable = true;
      options = [ "nofail" ];
    }
  ];
}
